# Plugins
## Included Plugins
Note: automatic loading of plugins can be configured by allow- and denylist in the bot's configuration.  
- `dates`: Stores dates and birthdays, posts reminders ([README.md](dates/README.md))
- `echo`: echoes back text following the command.
- `help`: lists all available plugins. If called with a plugin as parameter, lists all available commands
- `meter`: accurately measures someones somethingness
- `oracle`: predicts the inevitable future (german, sorry)
- `pick`: aids you in those really important life decisions
- `quote`: store quotes and provide several means to display them
- `roll`: the dice giveth and the dice taketh away
- `sample`: Just a simple sample, demonstrating the current capabilities of the `Plugin` interface
([README.md](sample/README.md))
- `sonarr`: provides commands to query sonarr's API
- `spruch`: famous quotes from even more famous people (german, sorry)
- `translate`: Provide translations of all room-messages via Google Translate (using googletrans, may break randomly) 
([README.md](translate/README.md))

## Included plugins' 3rd party requirements
- `dates`: [dateparser](https://pypi.org/project/dateparser/) to allow for almost arbitrary input format of dates
- `sonarr`:
  - [requests](https://pypi.org/project/requests/) to query sonarr's API
  - [humanize](https://pypi.org/project/humanize/)
- `translate`: [googletrans](https://pypi.org/project/googletrans/) to provide language detection and translation

## Plugins can
- ‚úî use (almost) arbitrary python-code
- ‚úî be supplied
  - inside their own directory (e.g. `plugins/sample/sample.py`) (encouraged since [v0.0.2](https://github.com/alturiak/nio-smith/releases/tag/v0.0.2))
  - as a single file (e.g. `plugins/sample.py`) (deprecated with [v0.1.0](https://github.com/alturiak/nio-smith/releases/tag/v0.1.0))
- ‚úî send room-messages
- ‚úî replace (edit) their sent messages
- ‚úî hook into to received room-messages
- ‚úî send reactions to specific messages
- ‚úî hook into to received reactions
- ‚úî add multiple commands (with required power levels) 
- ‚úî limit commands to certain rooms
- ‚úî use built-in persistent storage
- ‚úî request creation of a backup of the currently stored plugin data
- ‚úî automatically be supplied with config-values from plugin-specific config-files at startup
- ‚úî register timers for method execution at custom intervals or at the start of each:
    - week,
    - day or
    - hour
- ‚ùå not hook into other room-events (yet)

## Plugins must
- ‚úî use async
- ‚úî instantiate `core.plugin.Plugin` as `plugin`
- ‚úî be uniquely named and use this name as
  - directory-name (`plugins/sample/`)
  - file-name (`plugins/sample/sample.py`)
  - plugin-name when instantiating `Plugin`: `plugin = Plugin("sample", "General", "Just a simple sample.")`
- ‚ùå not use `time.sleep()` - please use `asyncio.sleep()` instead

## Plugins should
- ‚úî handle exceptions themselves (they will eventually be caught by the bot, but will produce error logs)
- ‚úî use [type hints](https://docs.python.org/3/library/typing.html)
- ‚úî adhere to [PEP 8](https://www.python.org/dev/peps/pep-0008/) (except for
[maximum-line-length](https://www.python.org/dev/peps/pep-0008/#maximum-line-length) - anything up to 160 is fine by
 me)
- ‚úî contain a README.md in their directory for a detailed description about
    - their intended use,
    - usage of commands and
    - additional requirements.

## Plugin file structure
- üìÇ `plugins/<pluginname>/`: folder holding anything related to the plugin  
  - `<pluginname>.py`: the actual python code of the plugin
  - `<pluginname>.yaml`: optional configuration file of the plugin
  - `<pluginname>.sample.yaml`: optional sample configuration file of the plugin
  - `<pluginname>.json`: (autogenerated) file to store any data stored by `store_data`
  - `<pluginname>.json.bak.<timestamp>`: backup-file created by calling `backup_data` - NO automatic backups as of now
  - `<pluginname>_state.json`: (autogenerated) current state of the plugin, used to store e.g. dynamic timers
  - `README.md`: optional documentation of the plugin  
  - `requirements.txt`: external modules required by the plugin

Additional files may be placed in the plugin's directory (e.g. an external database queried by the plugin's code).

## Plugin Interface
The class `Plugin` is used by all plugins, providing the following methods. See 
[sample.py](sample/sample.py) for examples.  
Please be advised that the plugin interface is about to
[change](https://github.com/alturiak/nio-smith/blob/master/BREAKING.md#simplify-plugins-interface) in future releases.

### Commands
- `add_command`: define
    - a command word,
    - the method called when the command is encountered,
    - a short helptext and
    - an optional list of rooms the command is valid for
- `del_command`: remove a previously added command (only if command_type=="dynamic")

### Interactions
#### Messages
- `replace_message`: replace (edit) a previously sent message
- `respond_message`: respond to a command with a message
- `respond_notice`: respond to a command with a notice (also called "bot message")
- `send_message`: send a message to a room
- `send_notice`: send a notice (also called "bot message") to a room

#### Reactions
- `send_reaction`: react to a specific event

#### Deletion
- `redact_event`: Redact (delete) an event

#### Other
- `get_mx_user_id`: given a displayname and a command, returns a mx user id
- `is_user_in_room`: checks if a given displayname is a member of the current room
- `link_user`: given a displayname, returns a link to the user (rendered as userpill in [Element](https://element.io))

### Data persistence
- `store_data`: persistently store data for later use
- `read_data`: read data from store
- `clear_data`: clear stored data
- `backup_data`: create a backup copy of the currently stored plugin data in `<pluginnname>.json.bak.<timestamp>` 

### Configuration
- `add_config`: define
    - a config_item to look for in `<plugin_name>.yaml`
    - an optional default_value
    - if the value is required (must be in configuration or have a default value)
- `read_config`: read a config_item, either returning the value found in the configuration file or the default_value,
  if supplied

### Hooks
- `add_hook`: define
    - an event type to be hooked into
        - "m.room.message": normal text messages sent to rooms
        - "m.reaction": reactions to room messages
    - the method called when the event is encountered,
    - an optional list of rooms the hook is valid for
- `del_hook`: remove a previously added hook (only if hook_type=="dynamic")

### Timers
- `add_timer`: define
    - the method to be called (currently once every ~30s whenever a sync event is received)
    - the frequency, in which the method is to be called, either as
        - datetime.timedelta or
        - str: "weekly", "daily", "hourly"
- `del_timer`: remove a previously added timer (only if `timer_type=="dynamic"`)
- `has_timer_for_method`: check if a timer for the given method exists

## Configuration
Plugins can read additional configuration options from the file `plugins/<pluginname>/<pluginname>.yaml`.  
Any configuration item that is to be used within the plugin has to be defined by `add_config()` first. It's value can 
then be read at anytime by calling `read_config()`. See [sample.py](sample/sample.py) for examples.  

## Documentation URL for each individual plugin
If present in `<pluginname>.yaml`, the configuration item `doc_url` will automatically be read and used by the 
output of `help`. This happens internally, so there is no need to define `add_config("doc_url")` in the actual 
plugin code.
