version: '3.1' # specify docker-compose version

volumes:
  # Set up with `docker volume create ...`. See docker/README.md for more info.
  nio-state:
    external: true
  # dirty workaround to make single plugin state persistent between builds
  # Set up with `docker volume create ...`. See docker/README.md for more info.
  plugin-cashup-state:
    external: true

services:
  # TODO delete or implement docker hub stuff!
  # Runs from the latest release 
  #nio-smith:
  #  image: ${USER}/nio-smith
  #  restart: always
  #  volumes:
  #    - data_volume:/data
  #  # Used for allowing connections to homeservers hosted on the host machine
  #  # (while docker host mode is still broken on Linux).
  #  #
  #  # Defaults to 127.0.0.1 and is set in docker/.env
  #  extra_hosts:
  #    - "localhost:${HOST_IP_ADDRESS}"

  # Builds and runs an optimized container from local code
  nio-smith:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # Build arguments may be specified here
      # args:
      #  PYTHON_VERSION: 3.9
    volumes:
      # external volume containing dbs with bot state
      # read/write state volume!
      - "nio-state:/home/nio-smith/data/state:rw"
      # external volume containing plugin cashup state
      # read/write state volume!
      #- "plugin-cashup-state:/home/nio-smith/plugins/cashup/cashup.json:rw"
      - "../plugins/cashup/:/home/nio-smith/plugins/cashup/:rw"
      # read only config volume!
      # not considering build context, so go one level up
      - "../data/config:/home/nio-smith/data/config:ro"
    # Used for allowing connections to homeservers hosted on the host machine
    # (while docker host networking mode is still broken on Linux).
    #
    # Defaults to 127.0.0.1 and is set in docker/.env
    extra_hosts:
      - "localhost:${HOST_IP_ADDRESS}"
    # restart on failure: https://stackoverflow.com/questions/56583099/restart-docker-container-on-inner-process-crash
    deploy:
      restart_policy:
        condition: on-failure
        delay: 60s
        window: 360s