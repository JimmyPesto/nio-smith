version: '3.4' # specify docker-compose version

volumes:
  # bot general state (eg. sqlite db etc)
  nio-state:
    external: false
  # plugin states (eg. json files)
  nio-plugin-states:
    external: false


services:
  # Builds and runs an optimized container from local code
  nio-smith:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # Build arguments may be specified here
      # args:
      #  PYTHON_VERSION: 3.9
    volumes:
      # mount read only bot main and plugin config files as volume!
      # not considering build context, so go one level up (../)
      - "../data/config/:/home/nio-smith/data/config/:ro"

      # named volume containing dbs with general bot state and plugin states
      # read/write state volume!
      - "nio-state:/home/nio-smith/data/state:rw"


    # Used for allowing connections to homeservers hosted on the host machine
    # (while docker host networking mode is still broken on Linux).
    #
    # Defaults to 127.0.0.1 and is set in docker/.env
    extra_hosts:
      - "localhost:${HOST_IP_ADDRESS}"
    # restart on failure: https://stackoverflow.com/questions/56583099/restart-docker-container-on-inner-process-crash
    deploy:
      restart_policy:
        condition: on-failure
        delay: 60s
        window: 360s